<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.digitalchina.sport.mgr.resource.dao.StatisticsDao">
    <select id="getStatisticsByPaytypes" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT
        create_date as createDate
        <if test="payTypes!=null">
            <foreach collection="payTypes" item="item"
                     index="index" open="," close=" " separator=",">
                SUM(IF(sd.pay_type = #{item}, price, 0)) AS '${item}'
            </foreach>
        </if>
        FROM
        statistics_data sd WHERE 1=1
        <if test="userId!=null and userId != ''">
            AND user_id=#{userId}
        </if>
        <if test="sDate!=null and sDate != ''">
            AND create_date &gt;=str_to_date(#{sDate},'%Y-%m-%d %H:%i:%s')
        </if>
        <if test="eDate!=null and eDate != ''">
            AND create_date &lt;=str_to_date(#{eDate},'%Y-%m-%d %H:%i:%s')
        </if>
        <if test="stadiumId!=null and stadiumId != ''">
            AND stadium_id=#{stadiumId}
        </if>
        <if test="subStadiumId!=null and subStadiumId != ''">
            AND sub_stadium_id=#{subStadiumId}
        </if>
        GROUP BY
        stadium_id,
        create_date
        <if test="subStadiumId!=null and subStadiumId != ''">
            ,sub_stadium_id
        </if>

    </select>
    <select id="getStatisticsByTicketTypes" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
            create_date AS createDate
            <if test="ticketTypes!=null">
                <foreach collection="ticketTypes" item="item"
                         index="index" open="," close=" " separator=",">
                    SUM(IF(sbp.ticket_type = #{item}, price, 0)) AS '${item}'
                </foreach>
            </if>
            FROM statistics_data sbp WHERE 1=1
            <if test="userId!=null and userId != ''">
                AND sbp.user_id=#{userId}
            </if>
            <if test="sDate!=null and sDate != ''">
                AND sbp.create_date &gt;=str_to_date(#{sDate},'%Y-%m-%d %H:%i:%s')
            </if>
            <if test="eDate!=null and eDate != ''">
                AND sbp.create_date &lt;=str_to_date(#{eDate},'%Y-%m-%d %H:%i:%s')
            </if>
            <if test="mainStadiumId!=null and mainStadiumId != ''">
                AND sbp.stadium_id=#{mainStadiumId}
            </if>
            <if test="subStadiumId!=null and subStadiumId != ''">
                AND sbp.sub_stadium_id=#{subStadiumId}
            </if>
        GROUP BY
            sbp.stadium_id,
            create_date
            <if test="subStadiumId!=null and subStadiumId != ''">
                ,sub_stadium_id
            </if>
    </select>
    <select id="getStatisticsInfo" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT
        sub_stadium_id AS subStadiumId,
        ticket_type AS ticketType,
        create_date as createDate
        <if test="payTypes!=null">
            <foreach collection="payTypes" item="item"
                     index="index" open="," close=" " separator=",">
                SUM(IF(sd.pay_type = #{item}, price, 0)) AS '${item}'
            </foreach>
        </if>
        FROM
        statistics_data sd WHERE 1=1
        <if test="userId!=null and userId != ''">
            AND user_id=#{userId}
        </if>
        <if test="ticketType!=null and ticketType != ''">
            AND ticket_type=#{ticketType}
        </if>
        <if test="sDate!=null and sDate != ''">
            AND create_date &gt;=str_to_date(#{sDate},'%Y-%m-%d %H:%i:%s')
        </if>
        <if test="eDate!=null and eDate != ''">
            AND create_date &lt;=str_to_date(#{eDate},'%Y-%m-%d %H:%i:%s')
        </if>
        GROUP BY
        stadium_id,
        sub_stadium_id,
        ticket_type
    </select>
    <select id="callStatisticByPayType"  resultType="java.util.Map" parameterType="java.util.Map" statementType="CALLABLE">
        {call statistic_by_pay_type(#{userId,jdbcType=VARCHAR,mode=IN},
        #{stadiumId,jdbcType=VARCHAR,mode=IN},
        #{sTime,jdbcType=VARCHAR,mode=IN},
        #{eTime,jdbcType=VARCHAR,mode=IN},
        #{ifDaily,jdbcType=VARCHAR,mode=IN},
        #{res,jdbcType=INTEGER,mode=OUT})}
    </select>
    <select id="getStatisticsDaily" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT
            id as id,
            user_id as userId,
            create_date as createDate,
            if_daily as ifDaily
        FROM
            statistics_data
        WHERE
            create_date = #{createDate}
        AND user_id=#{userId}
        <if test="stadiumId!=null and stadiumId != ''">
            AND stadium_id=#{stadiumId}
        </if>
        GROUP BY
            user_id,
            stadium_id,
            create_date;
    </select>
    <select id="getPayment" resultType="String" parameterType="java.util.Map">
        SELECT
            sd.pay_type
        FROM
            statistics_data sd
        WHERE
            sd.user_id = #{userId}
        AND sd.stadium_id = #{stadiumId}
        GROUP BY
            sd.pay_type
    </select>
    <select id="getTicketType" resultType="String" parameterType="java.util.Map">
        SELECT
        sd.ticket_type
        FROM
        statistics_data sd
        WHERE
        sd.user_id = #{userId}
        AND sd.stadium_id = #{stadiumId}
        GROUP BY
        sd.ticket_type
    </select>
</mapper>